- [**Řízení přístupu k prostředkům**](#řízení-přístupu-k-prostředkům)
  - [**Oprávnění**](#oprávnění)
    - [**Vlastnictví objektů**](#vlastnictví-objektů)
    - [**Dědičnost oprávnění**](#dědičnost-oprávnění)
    - [**Vyhodnocení výsledného oprávnění**](#vyhodnocení-výsledného-oprávnění)
  - [**Přehled NTFS oprávnění**](#přehled-ntfs-oprávnění)
  - [**Sdílení**](#sdílení)
    - [**Soubory offline (Offline Files)**](#soubory-offline-offline-files)
  - [**Encrypting File System (EFS)**](#encrypting-file-system-efs)
  - [**BitLocker**](#bitlocker)
    - [**BitLocker To Go**](#bitlocker-to-go)
- [AutomatedLab](#automatedlab)
- [**Studentské úkoly**](#studentské-úkoly)
  - [**Lab LS01 -- NTFS oprávnění**](#lab-ls01----ntfs-oprávnění)
  - [**Lab LS02 -- Šifrování souborů pomocí EFS a záloha certifikátu**](#lab-ls02----šifrování-souborů-pomocí-efs-azáloha-certifikátu)
  - [**Lab LS03 -- Sdílení šifrovaných souborů**](#lab-ls03----sdílení-šifrovaných-souborů)
  - [**Lab LS04 -- Sdílení všech šifrovaných souborů**](#lab-ls04----sdílení-všech-šifrovaných-souborů)
  - [**Lab LS05 -- Vytvoření Agenta Obnovení**](#lab-ls05----vytvoření-agenta-obnovení)
  - [**Lab LS06 -- Sdílení**](#lab-ls06----sdílení)
  - [**Lab LS07 -- Soubory offline**](#lab-ls07----soubory-offline)
- [**Bodované úkoly**](#bodované-úkoly)
  - [**Úkol 1**](#úkol-1)


# **Řízení přístupu k prostředkům**

Řízení přístupu je proces autorizace uživatelů, skupinám a počítačům
přistupovat k objektům. Předtím než subjekt může získat přístup k
objektu, musí se nejprve sám identifikovat bezpečnostnímu podsystému
operačního systému. Identita je přítomna v přístupovém žetonu (*access
token*), který je vždy znovuvytvořen při každém přihlášení. Nežli povolí
systém přístup k objektu, ověří, zdali má daný žeton oprávnění k
přístupu porovnáním informací z žetonu s bezpečnostními záznamy (ACE,
*Access Control Entry*) daného objektu. ACE může povolovat nebo
zakazovat velké množství chování. Například pro soubory může umožňovat
čtení, zápis nebo spouštění, pro tiskárny zase možnost tisku, správy
tiskárny nebo správy dokumentů v tiskové frontě.

Individuální záznamy ACE tvoří seznamy -- ACL (*Access Control List*).
Bezpečnostní systém prohledává ACL objektu tak dlouho, dokud nenajde ACE
záznam patřící danému uživateli nebo skupině, který by povoloval nebo
zakazoval přístup nebo neprohledá celý seznam. Pokud dojde až na konec
seznamu bez nalezení záznam o požadovaném typu přístupu, bezpečnostní
systém zamítne uživateli přístup.

## **Oprávnění**

Oprávnění definují typ přístupu povolující nebo zakazující uživateli
nebo skupině přístup k objektu nebo vlastnosti objektu. Například
skupině **Simpsons** povolí oprávnění číst soubor s názvem
**televizní_program.txt**. Pomocí uživatelského rozhraní můžete
nastavovat NTFS oprávnění na soubory, objekty **Active Directory**,
registrové záznamy, procesy, atd. Oprávnění mohou být udělena jakémukoli
uživateli, skupině nebo počítači. Je vhodné a doporučované přidělovat
oprávnění skupinám místo jednotlivým uživatelům nebo skupinám pro lepší
přehlednost, správu a výkon během ověřování.

Oprávnění přidělená k objektům závisí na jejich typu. Například
oprávnění pro soubory jsou trochu jiná, než oprávnění u registrových
záznamů. Nicméně velmi často jsou oprávnění společná, jako například
oprávnění Čtení, Zápisu, Modifikace, Smazání.

Když nastavujete oprávnění, určujete úroveň přístupu dané skupiny nebo
uživatele. Například uživatel může nechat jednoho uživatele číst obsah
souboru, druhého soubor upravovat a měnit a všem ostatním odepřít
přístup k souboru kompletně. Obdobně nastavíte oprávnění u tiskáren,
několika uživatelům oprávnění spravovat tiskárnu a ostatním pouze
tisknout.

Pokud chcete nastavovat oprávnění na souboru, v průzkumníku klikněte
pravým tlačítkem myši na daný soubor, vyberte **Vlastnosti**. Na záložce
**Zabezpečení** můžete poté upravovat oprávnění.

### **Vlastnictví objektů**

Každému objektu je při jeho vytvoření přiřazen vlastník. Ve výchozím
nastavení vlastníkem je jeho tvůrce. Bez ohledu na oprávnění, jaká jsou
nastavená pro daný objekt, jeho vlastník může vždy tato oprávnění
upravovat.

### **Dědičnost oprávnění**

Dědičnost umožňuje administrátorům jednoduše spravovat a přidělovat
oprávnění. Tato funkce zajišťuje automatické kopírování všech oprávnění,
která jsou děditelná, z kontejneru, který obsahuje daný objekt.
Například soubor uvnitř složky, když je vytvořen, dědí oprávnění dané
složky. Pouze oprávnění označená k dědění budou zděděna. Zděděná
oprávnění jsou zobrazována zašedle a nejdou editovat. Existují tři
doporučené způsoby jak upravovat zděděná oprávnění:

-   Upravit oprávnění na rodičovském objektu, od něhož jsou oprávnění
    děděna.

-   U daného objektu můžete explicitně uvést povolující (**Allow**)
    oprávnění, které přepíše zděděný zákaz (**Deny**).

-   Zrušit zatržení u **Zahrnout zděditelná oprávnění z nadřazeného
    objektu**.

### **Vyhodnocení výsledného oprávnění**

Oprávnění se sčítají podle skupin, kterých je uživatel členem. Pokud
bude uživatel členem např. 3 skupin, kde každá bude mít jiná oprávnění
ke stejnému objektu, výsledná oprávnění uživatele budou součtem všech
oprávnění těchto skupin k danému objektu. Toto neplatí pro oprávnění
**Deny**. Toto oprávnění je nadřazeno všem ostatním. Pokud byť v jediné
skupině by bylo použito oprávnění **Deny** k některé akci, bude tato
akce danému uživateli zakázána, i kdyby byla ve všech ostatních
skupinách, jejichž je členem, povolena. Nicméně existuje výjimka i na
toto pravidlo právě s již zmíněnou dědičností, tedy explicitními
a zděděnými oprávnění. Uplatňují se tedy s touto prioritou:

1.  Explicitní odepřít (*Deny*)

2.  Explicitní povolit (*Allow*)

3.  Zděděné odepřít (*Deny*)

4.  Zděděné povolit (*Allow*)

Pro snadné vypočtení výsledných oprávnění obsahuje systém Windows
kalkulátor NTFS oprávnění, který bere v potaz členství uživatele ve
všech skupinách. Ve **vlastnostech** daného objektu, záložce
**Zabezpečení** klikněte na tlačítko **Upřesnit**. V novém okně na
záložce **Skutečná oprávnění** můžete určit účet, jehož výsledná
oprávnění vás zajímají a systém vám je zobrazí.

## **Přehled NTFS oprávnění**

NTFS oprávnění jsou základní a rozšířená a stejné oprávnění se jinak
chová pro složku a jinak pro soubor. Základní oprávnění se poté skládají
z kombinace více oprávnění rozšířených. V následující tabulce jsou
vypsána oprávnění, která lze nastavit, nebo naopak odepřít a složení
základních oprávnění z rozšířených.

  | Special Permissions          | Full Control | Modify | Read & Execute | Read | Write |
  | ---------------------------- | ------------ | ------ | -------------- | ---- | ----- |
  | Traverse Folder/Execute File | :heavy_check_mark:            | :heavy_check_mark:      | :heavy_check_mark:              |      |       |
  | List Folder/Read Data        | :heavy_check_mark:            | :heavy_check_mark:      | :heavy_check_mark:              | :heavy_check_mark:    |       |
  | Read Attributes              | :heavy_check_mark:            | :heavy_check_mark:      | :heavy_check_mark:              | :heavy_check_mark:    |       |
  | Read Extended Attributes     | :heavy_check_mark:            | :heavy_check_mark:      | :heavy_check_mark:              | :heavy_check_mark:    |       |
  | Create Files/Write Data      | :heavy_check_mark:            | :heavy_check_mark:      |                |      | :heavy_check_mark:     |
  | Create Folders/Append Data   | :heavy_check_mark:            | :heavy_check_mark:      |                |      | :heavy_check_mark:     |
  | Write Attributes             | :heavy_check_mark:            | :heavy_check_mark:      |                |      | :heavy_check_mark:     |
  | Write Extended Attributes    | :heavy_check_mark:            | :heavy_check_mark:      |                |      | :heavy_check_mark:     |
  | Delete Subfolders and Files  | :heavy_check_mark:            |        |                |      |       |
  | Delete                       | :heavy_check_mark:            | :heavy_check_mark:      |                |      |       |
  | Read Permissions             | :heavy_check_mark:            | :heavy_check_mark:      | :heavy_check_mark:              | :heavy_check_mark:    | :heavy_check_mark:     |
  | Change Permissions           | :heavy_check_mark:            |        |                |      |       |
  | Take Ownership               | :heavy_check_mark:            |        |                |      |       |
  | Synchronize                  | :heavy_check_mark:            | :heavy_check_mark:      | :heavy_check_mark:              | :heavy_check_mark:    | :heavy_check_mark:     |


## **Sdílení**

Umožňuje využívat prostředky vzdáleného systému tak, jako by byly
přístupné lokálně. U sdílení souborů rozlišujeme 3 typy sdílení --
běžné, administrativní a skryté. Administrativní sdílení je skryté
sdílení, jejž mohou využívat pouze členové skupiny **Administrators**.
Administrativně jsou sdíleny složky Windows (**ADMIN\$**), oddíly
pevných disků (***\<jednotka\>*\$**, např. **C\$**, **D\$** atd.)
a **IPC\$**.

Skryté sdílení umožňuje přístup pouze, když zadám úplnou UNC cestu
(nemohu se k němu proklikat - *browse*). Skryté sdílení končí vždy
dolarem **\$**.

Postup při přístupu na sdílení: Nejdříve firewall ověří, zda je povoleno
sdílení. V druhém kroku je ověřeno, zda má uživatel právo přístupu k
počítači ze sítě. Pokud má právo přístupu ze sítě, ověří se oprávnění
sdílení. Nakonec se ověří oprávnění NTFS.

U oprávnění sdílení platí stejná pravidla jako u oprávnění NTFS. Pokud
je uživatel ve více skupinách, je výsledné oprávnění sjednocením
oprávnění jednotlivých skupin. **Deny** je silnější než **Allow** --
pokud má v jedné skupině právo **Allow Read**, ale v druhé skupině má
právo **Deny Read** je výsledkem **Deny Read**.

Výsledné oprávnění je průnikem oprávnění sdílení a oprávnění NTFS.
Například, pokud mám oprávnění sdílení **Allow Read**, ale u NTFS nemám
**Read** uvedeno, je výsledkem, že nemohu číst danou složku.

Microsoft považuje za dobrou praxi, nastavit skupině **Authenticated
Users** nebo **Everyone** oprávnění **Full Control** pro sdílená
oprávnění a následně spoléhat na NTFS oprávnění, která budou mít
standardní konfiguraci, která se uplatní jak lokálně, tak i na všechny
přístupy po síti (oprávnění přístupu přes síť se netýká funkce
**Vzdálené plochy**). Tento postup je považován za efektivní způsob
řízení přístupu k místním a síťovým datům. Poskytuje také dobrou
strategii při zálohování, změně názvu nebo umístění.

### **Soubory offline (Offline Files)**

Speciální typ synchronizace. Umožňuje přistupovat k souborům na síti, i
když k této síti není uživatel připojen. Nejde o nic jiného než
vytvoření kopií těchto souborů na lokálním počítači a jejich neustálé
synchronizaci. Pro zpřístupnění souborů offline je nejprve potřeba
globálně povolit tuto službu, následně označit požadované soubory jako
přístupné offline a nakonec pomocí **Centra synchronizace** provést
synchronizaci, aby byly tyto soubory přeneseny na cílové zařízení. Od
Windows 7 došlo k integraci globálního nastavení **Souborů offline** do
**Centra synchronizace**, kde je přístupné skrz Spravovat soubory
offline v levém panelu **Centra synchronizace**.

Soubory offline tvoří obousměrné partnerství pro synchronizaci, takže
zde může docházet ke konfliktům. Protože tyto soubory mohou být důvěrné
a jsou často synchronizovány na mobilní zařízení, je zde velké
nebezpeční jejich odcizení odcizením daného zařízení. Pro zabezpečení
těchto dat lze tyto data šifrovat pomocí systému EFS a tím zabránit
jejich zneužití.

## **Encrypting File System (EFS)**

Nejčastější ochranou dat v systémech Windows je využití možností
zabezpečení NTFS souborového systému. Soubory mají definovány přístupové
oprávnění a systém při každém přístupu k těmto datům kontroluje, zda
přihlášený uživatel má oprávnění provádět vyžadovanou operaci. V tomto
případě ale nejde o ochranu na úrovni dat, ale na úrovni přístupu k
datům, samotná data nejsou nijak chráněna. Pokud útočník získá fyzický
přístup k datům, např. získá pevný disk, může tento disk připojit
k jinému počítači, kde má oprávnění modifikovat přístupová práva (má
účet s administrátorskými právy), nebo kde jednoduše vůbec k ověřování
práv nedochází (např. jiný operační systém jako Linux s adekvátními
ovladači NTFS souborového systému).

**EFS** poskytuje ochranu na úrovni dat, takže data jsou čitelná pouze
pro uživatele vlastnící validní dešifrovací klíč. **EFS** není služba
systému Windows, ale služba souborového systému NTFS, takže lze šifrovat
pouze soubory na oddílech naformátovaných jako NTFS. Výhodou **EFS** je
transparentnost, veškeré šifrování a dešifrování probíhá na pozadí
a uživatel ani nemusí vědět, že je soubor, se kterým pracuje,
zašifrován.

**EFS** využívá pro svou činnost kombinaci symetrické a asymetrické
kryptografie. Symetrická kryptografie využívá jediný klíč pro
zašifrování i dešifrování dat, zatímco asymetrická kryptografie využívá
klíče dva - veřejný klíč pro zašifrování dat a privátní klíč pro
dešifrování dat, u systému EFS jsou tyto klíče ve formě certifikátu. Při
šifrování dat se nejprve vygeneruje klíč (FEK, *File Encryption Key*),
kterým se pomocí symetrické kryptografie zašifrují data. Poté se pomocí
veřejného klíče uživatele zašifruje asymetricky tento vygenerovaný klíč.
Při dešifrování se nejprve dešifruje FEK a poté se tímto klíčem
dešifrují data.

Kombinace těchto dvou technik poskytuje řadu výhod. Symetrická
kryptografie je velice rychlá[^1], což je výhodné pro šifrování velkého
množství dat, ovšem představuje riziko z hlediska ochrany samotného
klíče pro šifrování. Asymetrická kryptografie je pomalá, což je ovšem
při šifrování malého objemu dat (u **EFS** pouze FEK) zanedbatelné, ale
zato velice bezpečná. Také tento způsob umožňuje jednoduše realizovat
přístup více uživatelů k zašifrovaným datům, stačí pouze zašifrovat FEK
veřejným klíčem dalšího uživatele a přiložit tento zašifrovaný řetězec
k souboru.

Je důležité pamatovat na to, že **EFS** poskytuje ochranu na úrovni dat.
Pokud útočník nemá dešifrovacím klíč, nedostane se k datům, ovšem stejná
situace může nastat i z pohledu uživatele, pokud ztratí svůj certifikát,
který obsahuje dešifrovací klíč. Je tedy vhodné mít tento certifikát
zálohovaný a bezpečně uložený pro případ ztráty. Windows poskytují
průvodce, který umožní uživateli jednoduše zálohovat nebo obnovit svůj
certifikát. Protože uživatelé často opomíjejí zálohování svých
certifikátů, poskytuje systém Windows také možnost vytvoření tzv.
**Agenta Obnovení** (*Recovery Agent*, RA), který má schopnost
dešifrovat jakákoliv data zašifrovaná pomocí EFS. Princip fungování
**Agenta Obnovení** je jednoduchý, jak již bylo zmíněno dříve, ke
každému zašifrovanému souboru lze přidat další uživatele, kteří mohou
soubor dešifrovat, systém tedy pouze přidá **Agenta Obnovení** jako
dalšího uživatele, který má právo soubor dešifrovat při každém šifrování
souboru, které na počítači v budoucnu proběhne. Soubory před vytvořením
**Agenta Obnovení** pro něj ale **nebudou** přístupné, pro zpřístupnění
lze ovšem využít nástroj **cipher**, který umožňuje aktualizovat
zašifrované FEK jednotlivých souborů a dodat potřebná data pro
zpřístupnění souborů **Agentovi Obnovení**.

## **BitLocker**

Nová možnost šifrování dat od Windows Vista, podporován pouze v edicích
Pro a Enterprise u Windows 10, resp. v edicích Enterprise a Ultimate u
Windows Vista až Windows 8.1. **BitLocker** se od **EFS** odlišuje
několika klíčovými vlastnostmi:

-   Šifruje celý oddíl, včetně souborů všech uživatelů a souborů systému
    (**EFS** neumožňuje šifrování systémových souborů).

-   Chrání počítač ihned po startu, před tím než naběhne operační
    systém. Po startu operačního systému je již kompletně transparentní.

-   Poskytuje šifrování na úrovni počítače, ne na úrovni uživatele. Pro
    zabezpečení souborů proti jiným nepovolaným uživatelům je potřeba
    využít systému **EFS**.

-   Umožňuje chránit integritu operačního systému, čímž napomáhá chránit
    proti rootkitům a offline útokům (externí modifikace systémových
    souborů).

**BitLocker** vyžaduje pro svou činnost dva oddíly NTFS, první
obsahující operační systém a druhý obsahující alespoň 350MB volného
místa (1,5GB u Windows Vista), který bude použit jako bootovací oddíl.
Existují dvě možnosti kde skladovat symetrický klíč používaný pro
šifrování dat:

-   **TPM** (*Trusted Platform Module*) čip verze 1.2 -- obsažen přímo
    v počítači.

-   **USB flash disk** -- vyžaduje připojení při každém startu počítače nebo přechodu z hibernace.

Pokud počítač obsahuje **TPM** čip, jsou k dispozici dva režimy
činnosti:

-   **Pouze TPM** -- Transparentní uživateli, během startu počítače
    **BitLocker** ověří u **TPM** integritu počítače a operačního
    systému. Pokud **TPM** není nalezeno, pevný disk byl přesunut nebo
    došlo ke změně startovacích souborů, přejde **BitLocker** do režimu
    obnovení (*recovery mode*) a bude po uživateli požadovat klíč pro
    obnovení (*recovery key*) nebo připojit USB flash disk obsahující
    tento klíč. **BitLocker** zde poskytuje pouze ochranu proti krádeži
    pevného disku.

-   **TPM s klíčem pro start a/nebo PINem** -- Kromě ověření u **TPM**
    bude **BitLocker** navíc požadovat po uživateli klíč pro start
    (USB flash disk) a/nebo PIN (resp. heslo). **BitLocker** zde
    poskytuje jak ochranu proti odcizení pevného disku tak celého
    počítače.

Pokud není **TPM** k dispozici, lze pro uložení symetrického klíče
použít USB flash disk. Pokud dojde ke ztrátě tohoto disku, lze pro
obnovu dat použít klíč pro obnovení (*recovery key*), který je sdělen
uživateli při aktivaci **BitLockeru**.

Hlavním cílem **BitLockeru** je co nejlépe ochránit symetrický klíč pro
šifrování obsahu disku, tzv. *Full Volume Encryption Key* (**FVEK**).
**FVEK** je uložen na **TPM** čipu, případně na USB flash disku (jenž
ale ve srovnání s **TPM** čipem neposkytuje tak vysokou bezpečnost).
**TPM** čip obsahuje sadu registrů, tzv. PCRs (*Platform Configuration
Registers*), jejichž obsah je při spuštění počítače vynulován. Obsah
těchto registrů může být změněn pouze speciální funkcí **extend**, jenž
nastaví hodnotu registru na hash předchozí hodnoty registru a předaného
datového řetězce. Tedy cílová hodnota je hash přes všechny předané
datové řetězce a jediný způsob jak získat identickou hodnotu je provést
stejnou sekvenci volání **extend**. Pro získání / uložení **FVEK** klíče
poté slouží funkce **unseal** / **seal**. Funkce **seal** zašifruje
**FVEK** klíč na základě hodnoty PCR registrů, funkce **unseal** naopak
dešifruje **FVEK** klíč, pokud je hodnota PCR registrů totožná s
hodnotou, jakou měly v době šifrování klíče.

Základní princip fungování **BitLockeru** je poté následující. Během
startu počítače sledují **PCR** registry kód, jenž se vykonává, a na
jeho základě modifikují svůj obsah. Při normálním startu dosáhnou
hodnoty **PCR** registrů stejných hodnot, jakých nabývaly při šifrování
**FVEK** klíče a lze tedy **FVEK** klíč úspěšně dešifrovat. V případě
nastartování jiného operačního systému bude hodnota **PCR** registrů
odlišná a nebude možné tedy disk dešifrovat (přesněji nebude možné
dešifrovat systémový oddíl disku původního operačního systému, jiné
operační systémy mohou normálně startovat, jen nebudou mít přístup k
tomuto oddílu disku).

Více v detailu dochází při startu počítače nejprve k spuštění kódu
BIOSu. První část tohoto kódu je neměnná a zajišťuje rozšíření PCR BIOSu
(volání funkce **extend**) o celý kód BIOSu. Pokračuje se vykonáváním
kódu BIOSu, jenž následně načte MBR disku a použije obsah sektoru s MBR
k rozšíření **PCR** zaváděcího sektor (Boot Sector **PCR**) a spustí kód
uložený v MBR. Dále dochází ještě k několika takovýmto iteracím, kdy se
načtený kód vždy nejprve použije k rozšíření nějakého **PCR** registru
a následně se vykoná. Volání funkce **extend** nijak neovlivňuje start
jiných operačních systémů, ty obsah **PCR** registrů ignorují.

Samotné šifrování obsahu disku využívá AES-CBC algoritmus + Elephant
diffuser. AES-CBC podporuje klíče délky 128 a 256 bitů. Elephant
diffuser je proprietární implementace algoritmu, jenž zajišťuje tzv.
*diffusion* vlastnost. Tato vlastnost zajišťuje, aby neuniformní
distribuce písmen v původním textu byla redistribuována v mnohem
složitější neuniformní distribuci v šifrovaném textu, neboli bity
šifrovaného textu by měly velice složitě záviset na bitech původního
textu. Jakmile se tedy změní jediný bit původního textu, mělo by dojít
ke kompletní změně odpovídajícího šifrovaného textu. Diffusery pracují v
obou směrech, jak ve směru úpravy původních dat na šifrovaná, tak
opačně. **BitLocker** využívá celkem dva diffusery, oba jsou navrženy
tak, aby měly dobré *diffusion* vlastnosti v jednom směru na úkor
špatných vlastností v opačném směru. Oba pak poskytují dohromady dobré
vlastnosti v obou směrech.

Postupně v Bitlockeru přibyly další možnosti:

[Windows 8 a Windows Server 2012]{.underline}

-   možnost šifrovat disk z WinPE ještě před samotnou instalací OS
    (BitLocker provisioning)

-   šifrování pouze využitého místa (a ne celého oddílu)

-   možnost změny PINu a hesla běžným uživatelem

-   automatické odemknutí systémového oddílu při bootu, pokud se počítač
    nachází v lokální síti (Windows 2012 a novější) -- obdoba varianty
    TPM s klíčem pro start, kdy klíč je umístěn na serveru

[Windows 10 a Windows Server 2016]{.underline}

-   DMA port protection -- možnost zablokovat hot-plug DMA (direct
    memory access) PCI porty do přihlášení a zablokování aktuálně
    nepoužívaných portů při uzamčení systému.

-   možnost umístění klíče do Azure Active Directory

-   \[verze 1511\] podpora šifrovacího algoritmu XTS-AES (s délkou klíče
    128 i 256bitů) místo původního AES-CBC

-   \[verze 1709\] zkrácení minimální délky PINu z 6 na 4 znaky

### **BitLocker To Go**

Rozšíření **Bitlockeru** o možnosti šifrování úložných zařízení
připojených přes USB. **Bitlocker To Go** podporuje celkem dva způsoby
odemykání (dešifrování obsahu) zařízení, buď na základě zadání hesla
nebo vložením smart karty.

Princip fungování **Bitlockeru To Go** je velice podobný **Bitlockeru**.
Využívá celkem tři klíče:

-   USB disk je zašifrován pomocí **VFEK** klíče, jenž opět využívá
    algoritmus AES-CBC s Elephant diffuser, ve výchozím nastavení je
    délka klíče 128 bitů.

-   **VFEK** je pak zašifrován pomocí 256 bitového klíče založeného na
    AES, tzv. **VMK** klíč (*Volume Master Key*).

-   **VMK** je nakonec zašifrován heslem zadaným uživatelem nebo
    přítomným na smart kartě.

Další novinkou je možnost konfigurace **Bitlocker To Go** pomocí
politik, kde je možné například zakázat používání USB zařízení, jenž
nemají **Bitlocker To Go** povolen, povolit možnost využití **Agenta
Obnovení** pro dešifrování obsahu nebo nastavit délku klíče AES-CBC
algoritmu.

---

# AutomatedLab

```pwsh
$labName = 'E04'
$adminPass = 'root4Lab'

New-LabDefinition -Name $labName -DefaultVirtualizationEngine HyperV -VmPath "E:\AutomatedLab-VMs"
Set-LabinstallationCredential -username root -password $adminPass

# Set up the defaults
# These will be used for all machines within your lab, unless you specifically overwrite them
$PSDefaultParameterValues = @{
    'Add-LabMachineDefinition:Processors' = 8
    'Add-LabMachineDefinition:Memory' = 16GB
    'Add-LabMachineDefinition:OperatingSystem' = 'Windows 11 Pro'
}

Add-LabVirtualNetworkDefinition -Name 'Default Switch' -HyperVProperties @{SwitchType = 'Internal'; AdapterName = 'Default Switch'}
Add-LabVirtualNetworkDefinition -Name 'Private1' -AddressSpace 192.168.0.0/24

$w11_1_network = @(
    New-LabNetworkAdapterDefinition -InterfaceName LAN0 -VirtualSwitch 'Default Switch' -UseDhcp 
    New-LabNetworkAdapterDefinition -InterfaceName LAN1 -VirtualSwitch Private1 -Ipv4Address 192.168.0.10/24 
)
Add-LabMachineDefinition -Name W11-1 -NetworkAdapter $w11_1_network

$w11_2_network = @(
    New-LabNetworkAdapterDefinition -InterfaceName LAN0 -VirtualSwitch 'Default Switch' -UseDhcp 
    New-LabNetworkAdapterDefinition -InterfaceName LAN1 -VirtualSwitch Private1 -Ipv4Address 192.168.0.11/24 -Ipv4Gateway 192.168.0.10
)
Add-LabMachineDefinition -Name W11-2 -NetworkAdapter $w11_2_network 

Install-Lab

Invoke-LabCommand -ActivityName 'Create Group - Simpsons' -ScriptBlock {
   New-LocalGroup -Name simpsons
} -ComputerName  W11-1 

Invoke-LabCommand -ActivityName 'Create User - Homer' -ScriptBlock {
    $username = 'homer'
    $password = 'root4Lab' | ConvertTo-SecureString -AsPlainText -Force
  
    New-LocalUser -Name "$username" -Password $password -FullName "$username"
    Add-LocalGroupMember  -Member "$username" -Group users
    Add-LocalGroupMember  -Member "$username" -Group administrators 
    Add-LocalGroupMember  -Member "$username" -Group simpsons 
} -ComputerName  W11-1 
 
Invoke-LabCommand -ActivityName 'Create User - Marge' -ScriptBlock {
    $username = 'marge'
    $password = 'user4Lab' | ConvertTo-SecureString -AsPlainText -Force
  
    New-LocalUser -Name "$username" -Password $password -FullName "$username"
    Add-LocalGroupMember  -Member "$username" -Group users
    Add-LocalGroupMember  -Member "$username" -Group simpsons 
} -ComputerName  W11-1 
 
Invoke-LabCommand -ActivityName 'Create User - Lisa' -ScriptBlock {
    $username = 'lisa'
    $password = 'user4Lab' | ConvertTo-SecureString -AsPlainText -Force
  
    New-LocalUser -Name "$username" -Password $password -FullName "$username"
    Add-LocalGroupMember  -Member "$username" -Group users
    Add-LocalGroupMember  -Member "$username" -Group simpsons 
} -ComputerName  W11-1 

Invoke-LabCommand -ActivityName 'Create User - Bart' -ScriptBlock {
    $username = 'bart'
    $password = 'user4Lab' | ConvertTo-SecureString -AsPlainText -Force
  
    New-LocalUser -Name "$username" -Password $password -FullName "$username"
    Add-LocalGroupMember  -Member "$username" -Group users
    Add-LocalGroupMember  -Member "$username" -Group simpsons 
} -ComputerName  W11-1

Show-LabDeploymentSummary
```

---

# **Studentské úkoly**

## **Lab LS01 -- NTFS oprávnění**

> **Cíl cvičení**
>
> Vyzkoušet si uplatňování NTFS oprávnění, dědičnost oprávnění a její
> rušení a také přebírání vlastnictví souborů a složek.
>
> **Potřebné virtuální stroje**
>
> **W11-1**
>
> **Další prerekvizity**
>
> Uživatelský účet **Homer**, jenž je členem skupiny **Administrators**.
>
> Uživatelské účty **Bart** a **Lisa**, jenž jsou členy skupiny
> **Users**.
>
> Skupina **Simpsons**, která obsahuje uživatelské účty **Homer**,
> **Bart** a **Lisa**.

1.  Přihlaste se na **W11-1** pod účtem **Homer**.

2.  Vytvořte složku **C:\\Simpsons**. Na nové složce otevřete Vlastnosti
    -\> Zabezpečení -\> Upravit (Properties -\> Security -\> Edit).
    Přidejte oprávnění Číst, Číst a spouštět a Zobrazovat obsah složky
    (Read, Read & execute a List folder content) členům skupiny
    **Simpsons**.

3.  Přihlaste se postupně pod všemi třemi účty rodiny **Simpsonů**
    a vytvořte si domovský adresář s odpovídajícím jménem (tj.
    C:\\Simpsons\\<jméno>). Zkontrolujte, zda se zdědila oprávnění pro
    skupinu **Simpsons**.

4.  Pod účtem **Lisa** si nyní vytvořte adresář
    **C:\\Simpsons\\Lisa\\Secrets**.

5.  Na složce **Secrets** vyberte Vlastnosti -\> Zabezpečení -\>
    Upřesnit -\> Oprávnění (Properties -\> Security -\> Advanced -\>
    Permissions).

6.  **Klepněte** na tlačítko Zakázat dědičnost (Disable inheritance). V
    následném dotazu zvolte Převést zděděná oprávnění na výslovná
    oprávnění pro tento objekt (Convert inherited permissions into
    explicit permissions on this object).

    -   **Lisa** si nepřeje, aby jí kdokoli další zasahoval do tajného
        adresáře, proto potřebuje zrušit zděděná oprávnění.

7.  Nyní upravte seznam oprávnění a potvrďte pomocí OK:

    1.  Odstraňte všechna oprávnění kromě **SYSTEM**.

    2.  Přidejte povolující oprávnění Úplné řízení (Allow Full Control)
        účtu **Lisa**.

    3.  Na závěr použijte tlačítko Použít (Apply).

8.  V okně Upřesnit nastavení zabezpečení secrets (Advanced Security
    Settings for secrests) se na kartě Platný přístup (Effective Access)
    přesvědčte o tom, zda opravdu **Bart** ani **Homer** nemají přístup
    k adresáři.

9.  Přihlaste se z ostatních účtů a ověřte, že nemohou přistupovat
    k obsahu.

10. Přihlaste se zpět jako **Lisa** a mezi oprávnění přidejte
    následující položky (**Lisa** je trochu paranoidní):

    1.  Bart -- Odepřít Úplné řízení (Deny Full Control)

    2.  Homer -- Odepřít Úplné řízení (Deny Full Control)

11. Nyní vytvořte v adresáři **Secrets** soubor **denik.txt** s nějakým
    obsahem.

12. Ověřte pro ostatní účty, že se nemohou dostat k obsahu adresáře
    **Secrets** ani k souboru **denik.txt**:

    -   Pomocí nástroje Skutečná oprávnění (Effective Permissions).

    -   Přihlášením pod daným účtem.

    -   Pokuste se otevřít v poznámkovém bloku soubor specifikováním
        celé cesty.

13. Přihlaste se zpět jako **Lisa**. Vytvořte v adresáři **Secrets**
    nový soubor **tajny.txt**. Udělte **Bartovi** oprávnění pro Čtení
    (Read) a Zápis (Write). Opakujte předchozí krok, **Bart** by měl
    být schopen otevřít soubor v poznámkovém bloku (dialog Otevřít
    z poznámkového bloku může vyžadovat i oprávnění Zobrazovat obsah
    složky (List Folder Content) Secrets. V takovém případě použijte
    **notepad.exe C:\\Simpsons\\Lisa\\Secrets\\tajny.txt**.

    -   **Lisa** s **Bartem** si budou chtít do tohoto souboru ukládat
        společné tajnosti tak, aby je **Homer** nezjistil.

14. Přihlaste se jako **Homer**. Na složce **Secrets** vyberte
    Vlastnosti -\> Zabezpečení -\> Upřesnit a Vlastník: ... Změnit
    (Properties -\> Security -\> Advanced a Owner: ... Change).
    Vyberte účet **Homer** a potvrďte pomocí OK.

    -   **Homer** nemůže najít svoje pivo a dobře ví, že před ním
         **Lisa** s **Bartem** něco schovávají. Využije tak svých
        administrátorských oprávnění a převezme vlastnictví složky
        a souboru **tajny.txt**.

15. Upravte si oprávnění pro možnost čtení. Tento postup opakujte pro
    možnost čtení souboru **tajny.txt**.

16. Změňte vlastnictví složky **Secrets** a souboru **tajny.txt** zpět
    na **Lisa**

    -   **Homer** nechce být odhalen a pokusí se zahladit stopy.

## **Lab LS02 -- Šifrování souborů pomocí EFS a záloha certifikátu**

> **Motivace**
>
> Poté, co se **Lisa** dozvěděla o tom, co **Homer** udělal, rozhodla se
> šifrovat soubor pomocí EFS.
>
> **Cíl cvičení**
>
> Zašifrovat soubor pomocí EFS, seznámit se s odlišnostmi mezi
> šifrováním a NTFS přístupovými právy, zálohovat certifikát pro
> dešifrování souborů uživatele.
>
> **Potřebné virtuální stroje**
>
> **W11-1**
>
> **Další prerekvizity**
>
> Dokončený úkol **Lab LS01**.

1.  Přihlaste se na **W11-1** jako **Lisa**.

2.  Zobrazte vlastnosti souboru **tajny.txt** a hned na záložce Obecné
    (General) vyberte Upřesnit ... (Advanced ...).

3.  Zatrhněte Šifrovat obsah a zabezpečit tak data (Encrypt contents to
    secure data).

    -   Pokud uživatel ještě nemá vytvořen certifikát pro EFS (sada
        privátního a veřejného klíče využívaného asymetrickou
        kryptografií pro šifrování FEK, viz [EFS](\l)), bude
        automaticky vytvořen operačním systémem.

4.  Potvrďte OK a v zobrazeném dialogu vyberte Zašifrovat pouze soubor
    (Encrypt file only).

5.  Přihlaste se jako **Homer** a ověřte, že ani uživatel
    s administrátorskými oprávněními nezobrazí obsah zašifrovaného
    souboru.

    -   Nezapomeňte, že v případě zabezpečení souboru jen pomocí NTFS
        přístupových práv by takovýto uživatel mohl data přečíst, ať
        již přímo nebo po převzetí vlastnictví souboru.

6.  Přihlaste se zpět jako uživatel **Lisa**.

7.  Otevřete Uživatelské účty (User Accounts) v Ovládacích panelech
    (Control panel) a vyberte Spravovat šifrovací certifikáty souborů
    (Manage your file encryption certificates).

8.  U výběru šifrovacího certifikátu zvolte Použít tento certifikát (Use
    this certificate).

9.  Zvolte Zálohovat certifikát a klíč nyní (Back up the certificate and
    key now), specifikujte cílový souboru pro zálohování (např.
    **C:\\Simpsons\\efsLisaPrivateCert.pfx**) a heslo (např. **aaa**)
    a pokračujte.

10. U aktualizace zašifrovaných souborů zvolte Všechny logické jednotky
    (All Logical Drives) a pokračujte.

    -   Aktualizace zajistí schopnost dešifrování dat, které byly
        zašifrovány před vytvořením tohoto certifikátu, ale pouze dat,
        ke kterým má daný uživatel přistup (tzn., může je např.
        dešifrovat pomocí jiných certifikátů apod.).

## **Lab LS03 -- Sdílení šifrovaných souborů**

> **Motivace**
>
> **Lisa** a **Bart** stále chtějí sdílet soubor **tajny.txt**.
>
> **Cíl cvičení**
>
> Umožnit sdílení konkrétního zašifrovaného souboru mezi více uživateli.
> **Bart** si vytvoří vlastní klíč pro šifrování a **Lisa** tento klíč
> použije k povolení přístupu k souboru **tajny.txt**.
>
> **Potřebné virtuální stroje**
>
> **W11-1**
>
> **Další prerekvizity**
>
> Dokončený úkol **Lab LS02**.

1.  Přihlaste se na **W11-1** jako **Bart**.

2.  Vytvořte si v domovském adresáři textový soubor a ten zašifrujte.

    -   **Bart** si potřebuje vytvořit nový certifikát pro EFS.

3.  Přepněte se na účet **Lisa**. U souboru **tajny.txt** otevřete
    Vlastnosti -\> Obecné -\> Upřesnit \... -\> Podrobnosti (Properties
    -\> General -\> Advanced \... -\> Details).

4.  Nyní pomocí Přidat (Add) přidejte **Bartův** certifikát.

5.  Ověřte, že **Bart** je nyní opět schopen číst soubor pomocí
    poznámkového bloku při zadání přesného umístění.

## **Lab LS04 -- Sdílení všech šifrovaných souborů**

> **Cíl cvičení**
>
> Zpřístupnění všech zašifrovaných souborů jednoho uživatele jinému
> uživateli importováním certifikátu prvního uživatele druhému
> uživateli.
>
> **Potřebné virtuální stroje**
>
> **W11-1**
>
> **Další prerekvizity**
>
> Dokončený úkol **Lab LS02**.

1.  Přihlaste se jako uživatel **Homer** a spusťte uložený certifikát
    **efsLisaPrivateCert.pfx**, zobrazí se Průvodce importem
    certifikátu (Certificate Import Wizard).

2.  Pokračujte dále s ponecháním výchozího nastavení až do části Heslo
    (Password), kde zadejte dříve specifikované heslo pro ochranu
    certifikátu a pokračujte.

3.  Jako Úložiště certifikátu (Certificate Store) ponechte výchozí
    automatický výběr a pokračujte.

4.  Potvrďte import certifikátu pomocí Dokončit (Finish).

5.  Ověřte, že nyní již uživatel **Homer** může otevřít a přečíst soubor
    **tajny.txt**.

## **Lab LS05 -- Vytvoření Agenta Obnovení**

> **Cíl cvičení**
>
> Vytvořit **Agenta obnovení**, jenž může dešifrovat jakýkoliv šifrovaný
> soubor na počítači.
>
> **Potřebné virtuální stroje**
>
> **W11-1**
>
> **Další prerekvizity**
>
> Dokončený úkol **Lab LS02**.

1.  Přihlaste se na W11-1 jako **Lisa**.

2.  Přidělte **root**ovi oprávnění Číst (Read) pro soubor
    **tajny.txt**.

3.  Přihlaste se jako uživatel **root**.

4.  Spusťte **Příkazový řádek** např. příkazem `cmd`.

5.  Vytvořte certifikáty pro **Agenta Obnovení** příkazem `cipher /R:racert` (jako heslo zvolte **aaa**).

6.  Otevřete Editor místních zásad skupiny (Local Group Policy Editor)
    např. příkazem `gpedit.msc`

7.  Vyberte Konfigurace počítače -\> Nastavení systému Windows -\>
    Nastavení zabezpečení -\> Zásady veřejných klíčů
    (Computer Configuration -\> Windows Settings -\> Security Settings
    -\> Public Key Policies).

8.  Klikněte pravým na Šifrování systému souborů (Encrypting File
    System) a zvolte Přidat Agenta obnovování dat ... (Add Data
    Recovery Agent ...).

9.  U Výběru agentu obnovení (Select Recovery Agents) zvolte
    Procházet složky ... (Browse Folders ...) a lokalizujte soubor
    **racert.CER**, vytvořený dříve pomocí nástroje `cipher`,
    a potvrďte instalaci certifikátu.

10. Pokračujte dále a potvrďte vytvoření **Agenta obnovení** pomocí
    Dokončit (Finish).

    -   Tento krok nevytvoří přímo **Agenta obnovení**, ale pomocí
        tohoto certifikátu bude zašifrován každý FEK jakéhokoliv
        souboru, který bude od tohoto okamžiku šifrován, tedy
        jakýkoliv uživatel vlastnící privátní klíč tohoto certifikátu
        se stane **Agentem obnovení**.

11. Importujte certifikát **racert.PFX**, vytvořený dříve pomocí
    nástroje `cipher` (viz. [Lab LS04 body 1-4](\l)).

    -   Importováním tohoto certifikátu získá uživatel **root**
        privátní klíč certifikátu, kterým jsou zašifrovány všechny FEK
        a stane se tedy **Agentem obnovení**.

12. Zkuste otevřít soubor **tajny.txt**.

    -   Obsah souboru nepůjde zobrazit, protože byl zašifrován ještě
        před vytvořením **Agenta obnovení**.

13. Přihlaste se jako uživatel **Lisa** a spusťte příkaz `cipher /U`.

14. Přihlaste se zpět jako uživatel **root** a zkuste nyní otevřít
    soubor **tajny.txt**.

    -   Nyní již soubor půjde zobrazit, protože nástroj `cipher`
        aktualizoval zašifrované soubory uživatele a doplnil FEK klíče
        zašifrované pomocí klíče **Agenta obnovení**.

## **Lab LS06 -- Sdílení**

> **Cíl cvičení**
>
> Vyzkoušet si pokročilé možnosti sdílení v systémech Windows.
>
> **Potřebné virtuální stroje**
>
> **W11-1**
>
> **W11-2**
>
> **Další prerekvizity**
>
> Vhodně nakonfigurovaný (nebo vypnutý) firewall pro používaný síťový
> profil (pravidla File and Printer Sharing).

1.  Přihlaste se na **W11-1** jako uživatel **root**

2.  Vytvořte složku **C:\\Smlouvy** a v ní soubor **sprava.txt**.

3.  Na složce **Smlouvy** otevřete Vlastnosti -\> Sdílení -\> Rozšířené
    možnosti sdílení (Properties -\> Sharing -\> Advanced Sharing).

4.  <a id="LS06_4"></a> Zatrhněte Sdílet tuto složku (Shared this
    folder) a nastavte:

    -   Název sdílené složky (Share name): **Firma**

    -   Komentáře (Comments): **Firemní smlouvy**

    -   Oprávnění (Permissions): **Everyone** povolit Úplné řízení
        (Allow Full Control)

5.  Přihlaste se lokálně na **W11-2** (uživatelské jméno
    **W11-2\\root**) a otevřete sdílenou složku
    z **Průzkumníka Windows** zadáním UNC cesty
    **\\\\W11-1\\Firma**.

6.  Vytvořte nové sdílení na složce **Smlouvy** (opakujte [krok 4](#LS06_4)), klikněte na tlačítko Přidat (Add) a nastavte:

    -   Název sdílené složky (Share name): **data**

    -   Oprávnění (Permissions): **Everyone** povolit Úplné řízení
        (Allow Full Control)\
        **Administrators** odepřít Číst (Deny Read)

7.  Ověřte, že účet patřící do skupiny **Administrators** (např.
    **root**) nemůže číst při přístupu ze sítě.

8.  Složku **Smlouvy** nasdílejte jako skryté sdílení s názvem **tajne**
    (opakujte [krok 4](#LS06_4)), klikněte na tlačítko Přidat
    (Add) a nastavte:

    -   Název sdílené složky (Share name): **tajne\$**

    -   Omezit současný počet uživatelů na: **1**

    -   Oprávnění (Permissions): **Everyone** povolit Číst (Allow Read)

9.  Ověřte, že sdílení není viditelné v **Průzkumníku Windows**.

10. Zadejte plnou cestu a přistupte na skryté sdílení.

## **Lab LS07 -- Soubory offline**

> **Cíl cvičení**
>
> Zpřístupnit obsah složky offline, ověřit dostupnost souborů ve složce,
> vyřešit konflikty.
>
> **Potřebné virtuální stroje**
>
> **W11-1**
>
> **W11-2**
>
> **Další prerekvizity**
>
> Adresář **C:\\Smlouvy** sdílený pod názvem **Firma** s povolením
> zápisu pro všechny na **W11-1**. Vhodně nakonfigurovaný (nebo
> vypnutý) firewall pro používaný síťový profil (pravidla File and
> Printer Sharing).

1.  Ve složce **C:\\Smlouvy** vytvořte soubor **offline.txt** s obsahem
    **Version 1**.

2.  Přihlaste se lokálně na **W11-2** jako uživatel **root**
    (pro lokální přihlášení je uživatelské jméno
    **W11-2\\root**) a otevřete sdílený adresář **Firma**.

3.  Zakažte veškeré síťové adaptéry a zkuste otevřít soubor
    **offline.txt**.

    -   Soubor nebude možné otevřít z důvodu nedostupnosti cílového
        sdílení.

4.  Povolte lokální síťový adaptér (**LAN2**) a obnovte (Refresh)
    sdílený adresář **Firma**.

5.  Klikněte pravým na sdílený adresář **Firma** a pak zvolte
    Vždy přístupné offline (Always Available Offline), počkejte na
    dokončení synchronizace.

6.  Opět zakažte veškeré síťové adaptéry a zkuste otevřít soubor
    **offline.txt**.

    -   Soubor nyní bude možné otevřít, jelikož je již uložen lokálně.

7.  Změňte obsah souboru **offline.txt** na obou místech (původní soubor
    i offline kopii).

8.  Opět povolte lokální síťový adaptér (**LAN2**).

9.  Otevřete vlastnosti (properties) souboru **offline.txt** a přepněte
    se na záložku Soubory offline (Offline Files).

10. Zvolte Synchronizovat nyní\... (Sync now\...).

11. Vyberte Zachovat obě verze (Keep both versions).

12. Ověřte, že adresář **C:\\Smlouvy** nyní obsahuje obě upravené verze
    souborů.

# **Bodované úkoly**

## **Úkol 1**

-   Vytvořte složku **Dokumenty** a nasdílejte ji tak, aby měl uživatel
    **root** ze sítě právo pouze **číst**. Ostatní uživatelé
    nebudou mít do složky přístup přes síť. Při přístupu přes síť
    budou mít právo přístupu pouze 2 uživatelé současně. Soubory musí
    být dostupné i tehdy, pokud nebude student připojen do sítě, a to
    v zabezpečené podobě.

<!-- **Řešení**

-   Na NTFS musí mít **root** (skupina **Administrators**, které je
    členem) minimálně **Allow Read** a** List folder content**, ale
    může mít až **Allow** **Full Control**. Na právech sdílení musí
    mít **root** **Allow Read** a ostatní práva ať nemá zaškrtnuta.
    Ostatní uživatelé nebudou uvedeni. Počet přístupů současně
    nastavit na **2**. Šifrované soubory offline.

-   Ověřit, že jsou nastavena správná oprávnění (viz výše), max. 2
    přístupy současně a šifrované soubory offline. -->

[^1]: Často se uvádí, že symetrická kryptografie je až 1000x rychlejší
    než asymetrická
